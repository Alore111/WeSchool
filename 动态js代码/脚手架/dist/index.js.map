{"version":3,"file":"index.js","mappings":";;;;;;;;;;AAAA;;AAEA;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AALA;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AATA;;AAYA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AACA;AADA;;AAIA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;;AAMA;AACA;AACA;AADA;AAIA;AAhBA;AAkBA;AArBA;AAuBA;AA1BA;AA4BA;AACA;AACA;AACA;AACA;;AAEA;AACA;AArEA;AAuEA;AACA;;;;;;;;AAQA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AAFA;AAIA;AAGA;;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAjBA;;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AAFA;AAPA;AAYA;AACA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;;;AAaA;AACA;AACA;AADA;AAIA;AACA;AACA;AAzCA;AA4CA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAjBA;;AAoBA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AANA;AAQA;AACA;AACA;AACA;AACA;;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AAFA;AAPA;AAYA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAhCA;AAkCA;AACA;AACA;AACA;AAzCA;AA2CA;AACA;AACA;AACA;AAjEA;AAoEA;AACA;AACA;AACA;AACA;AAFA;AAIA;AAEA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAlBA;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AACA;AALA;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AAFA;AAPA;AAYA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAhCA;AAkCA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;AApDA;AAsDA;AACA;AACA;AAGA;AACA;AACA;AA9EA;AAgFA;AACA;AACA;AACA;AACA;AACA;AAxFA;AA0FA;AACA;AACA;AACA;AACA;AAFA;AAIA;AAEA;;;AAEA;AACA;AAAA;AAAA;AAEA;;AAEA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;AAxoBA;AA6oBA;AACA","sources":["webpack://test/./dist/index.js"],"sourcesContent":["function runCode(){\n              \nconst db = wx.cloud.database({env:'mall-7gi19fir46652cb4'})\n  \n            \n            var Page = function(page){\n              return page\n            }\n          return Page({\n            \n            onLoad: function (options) {\n              options = this.options;\n              this.setdata({})\n            },\n            \n            parseTag(tag) {\n              let res = {\n                  type1: \"tag\",\n                  name: \"\",\n                  voidElement: false,\n                  // attrs: {},\n                  children: [],\n              };\n              let tagMatch = tag.match(/<\\/?([^\\s]+?)[/\\s>]/);\n              if (tagMatch) {\n                  // 标签名称为正则匹配的第2项\n                  res.type1 = tagMatch[1];\n                  if (tag.charAt(tag.length - 2) === \"/\") {\n                      // 判断tag字符串倒数第二项是不是 / 设置为空标签。 例子：<img/>\n                      res.voidElement = true;\n                  }\n              }\n              // 匹配所有的标签正则\n              let classList = tag.match(/\\s([^'\"/\\s><]+?)\\s*?=\\s*?(\".*?\"|'.*?')/g);\n            \n              if (classList) {\n                let style = ''\n                  for (let i = 0; i < classList.length; i++) {\n                      // 去空格再以= 分隔字符串  得到['属性名称','属性值']\n             \n                      let c = classList[i].split(\"=\");\n                      // c[1] = c[1].replace(/\\s*/g, \"\")\n                      c[0] = c[0].replace(/\\s*/g, \"\")\n                      // 循环设置属性\n                      var lengthc = 2\n                      for(lengthc; lengthc < c.length ; lengthc++){\n                        c[1] += \"=\" + c[lengthc]\n                      }\n                      let p = c[1].substring(1, c[1].length - 1)\n                      try{\n                        p = JSON.parse(c[1].substring(1, c[1].length - 1))\n                      }catch(e){\n                       \n                      }\n            \n                      if (c[1]) {\n                        if(c[0] === 'style'){\n                          style = p + style\n                          res[c[0]] = style\n                        }else{\n                          res[c[0]] = p\n                        }\n                \n                      };\n            \n                  }\n              }\n              return res;\n            },\n            \n            parse(html) {\n              var that = this;\n              let result = [];\n              let current;\n              let level = -1;\n              let arr = [];\n              let tagRE = /<[a-zA-Z\\-\\!\\/](?:\"[^\"]*\"['\"]*|'[^']*'['\"]*|[^'\">])*>/g;\n              html.replace(tagRE, function (tag, index) {\n                  // 判断第二个字符是不是'/'来判断是否open\n                  let isOpen = tag.charAt(1) !== \"/\";\n                  // 获取标签末尾的索引\n                  let start = index + tag.length;\n                  // 标签之前的文本信息\n                  let text = html.slice(start, html.indexOf(\"<\", start));\n            \n                  let parent;\n                  if (isOpen) {\n                      level++;\n                      // 设置标签属性\n                      current = that.parseTag(tag);\n                      // 判断是否为文本信息，是就push一个text children  不等于'  '\n                      if (!current.voidElement && text.trim()) {\n                          current[\"text\"] = text\n                      }\n                      // 如果我们是根用户，则推送新的基本节点\n                      if (level === 0) {\n                          result.push(current);\n                      }\n                      // 判断有没有上层，有就push当前标签\n                      parent = arr[level - 1];\n                      if (parent) {\n                          parent.children.push(current);\n                      }\n                      // console.log(current)\n                      arr[level] = current;\n                  }\n                  // 如果不是开标签，或者是空元素：</div><img>\n                  if (!isOpen || current.voidElement) {\n                      // level--\n                      level--;\n                  }\n              });\n              // console.log(result)\n              return result;\n            \n            },\n          setdata: function setdata(dictData) {\n            \n            for(var i in dictData){\n              this.data[i] = dictData[i]\n            }\n            var html = `<view class=\"bg-red flex justify-center\">\t<view class=\"action\">\t\t${typeof this.data.userinfo.userlocation.school === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.school) : this.data.userinfo.userlocation.school==typeof this.data.sf === \"object\" ? JSON.stringify( this.data.sf) : this.data.sf ? `<text >有问题联系电话:xxxxx！</text>`: ``}\t</view></view><view class=\"cu-card article\">\t<view class=\"cu-item shadow\" style=\"margin:30rpx 30rpx 0 30rpx\" bindtap=\"location\">\t\t${typeof this.data.userinfo.havelocation === \"object\" ? JSON.stringify( this.data.userinfo.havelocation) : this.data.userinfo.havelocation ? `<view >\t\t\t<view class=\"title\">\t\t\t\t<view class=\"text-cut text-xl text-black text-bold\">\t\t\t\t\t${typeof this.data.userinfo.userlocation.school === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.school) : this.data.userinfo.userlocation.school}-${typeof this.data.userinfo.userlocation.location === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.location) : this.data.userinfo.userlocation.location}-${typeof this.data.userinfo.userlocation.sushehao === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.sushehao) : this.data.userinfo.userlocation.sushehao}</view>\t\t\t</view>\t\t\t<view class=\"title\" style=\"font-weight:10;line-height:30rpx\">\t\t\t\t<view class=\"text-cut\">${typeof this.data.userinfo.userlocation.name === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.name) : this.data.userinfo.userlocation.name}-${typeof this.data.userinfo.userlocation.tell === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.tell) : this.data.userinfo.userlocation.tell}</view>\t\t\t</view>\t\t</view>`: `\t\t<view wx:else>\t\t\t<view class=\"title\">\t\t\t\t<view class=\"text-cut text-xl text-black text-bold text-blue\">点击添加地址</view>\t\t\t</view>\t\t</view>`}\t</view></view><view class=\"cu-card article\">\t<view class=\"cu-item shadow\" style=\"margin:10rpx 30rpx;padding-bottom:0\">\t\t<view class=\"title\">\t\t\t<view class=\"text-cut text text-black\">${typeof this.data.shop.name === \"object\" ? JSON.stringify( this.data.shop.name) : this.data.shop.name}</view>\t\t</view>\t\t${this.data.buy.buy.map((item, index) =>  ` <view >\t\t\t<view class=\"padding-xs flex align-center\">\t\t\t\t<image style=\"cu-avatar radius lg\" src=\"${typeof item.img === \"object\" ? JSON.stringify( item.img) : item.img}\" style=\"font-size: 2em; height: 130rpx; left: 20rpx; width: 130rpx;\"></image>\t\t\t\t<view class=\"flex-sub\" style=\"padding-left: 30rpx;\">\t\t\t\t\t<view class=\" text-xl\">\t\t\t\t\t\t<text class=\"text-black text-bold\">${typeof item.name === \"object\" ? JSON.stringify( item.name) : item.name}</text>\t\t\t\t\t</view>\t\t\t\t\t<view style=\"font-size: 30rpx;\">￥${typeof item.nowprice === \"object\" ? JSON.stringify( item.nowprice) : item.nowprice}X${typeof item.number === \"object\" ? JSON.stringify( item.number) : item.number}</view>\t\t\t\t</view>\t\t\t\t<view class=\"cu-avatar radius lg\" style=\"background-color: white; font-size: 2em; height: 130rpx; width: 130rpx;\">\t\t\t\t\t<text style=\"color:black;font-size:40rpx\"></text>\t\t\t\t</view>\t\t\t</view>\t\t</view>`)}\t\t<view class=\"flex title justify-end solids-top\" style=\"font-weight:10\">\t\t\t<view class=\"text-cut text-xxl\">\t\t\t\t<text class=\"text-red text-bold\">￥${typeof this.data.buy.totalprice === \"object\" ? JSON.stringify( this.data.buy.totalprice) : this.data.buy.totalprice}</text>\t\t\t</view>\t\t</view>\t</view></view><view class=\"cu-card article\">\t<view class=\"cu-item shadow\" style=\"margin:10rpx 30rpx;padding-bottom:0\">\t\t<view class=\"cu-form-group\">\t\t\t<view>预约情况</view>\t\t\t<picker bindchange=\"PickerChange\" value=\"${typeof this.data.index === \"object\" ? JSON.stringify( this.data.index) : this.data.index}\" range=\"${typeof this.data.picker === \"object\" ? JSON.stringify( this.data.picker) : this.data.picker}\">\t\t\t\t<view class=\"picker\">\t\t\t\t\t${typeof this.data.picker[typeof this.data.index === \"object\" ? JSON.stringify( this.data.index) : this.data.index] === \"object\" ? JSON.stringify( this.data.picker[typeof this.data.index === \"object\" ? JSON.stringify( this.data.index) : this.data.index]) : this.data.picker[typeof this.data.index === \"object\" ? JSON.stringify( this.data.index) : this.data.index]}\t\t\t\t</view>\t\t\t</picker>\t\t</view>\t</view></view><view class=\"cu-card article\">\t<view class=\"shadow\" style=\"margin:10rpx 60rpx;padding-bottom:0\">\t\t<text decode=\"true\">注：上午11点之后不可预约今天中午，&emsp;&emsp;下午17点之后不可预约今天晚上</text>${typeof this.data.userinfo.userlocation.school === \"object\" ? JSON.stringify( this.data.userinfo.userlocation.school) : this.data.userinfo.userlocation.school==typeof this.data.sf === \"object\" ? JSON.stringify( this.data.sf) : this.data.sf ? `<text decode=\"true\" >师范:&emsp;&emsp;周一到周五中午东门自取&emsp;&emsp;周五下午到周日送到宿舍！</text>`: ``}\t</view></view><view class=\"cu-card article\">\t<view class=\"cu-item shadow\" style=\"margin:0rpx 30rpx 0 30rpx\">\t\t<view class=\"title\">\t\t\t<view class=\"text-cut text-xl text-black text-bold\">备注</view>\t\t</view>\t\t<view class=\"cu-form-group\">\t\t\t<textarea bindinput=\"beizu\" style=\"margin: 0rpx\" maxlength=\"-1\" placeholder=\"请备注忌口、需求\"></textarea>\t\t</view>\t</view></view>${typeof this.data.allok === \"object\" ? JSON.stringify( this.data.allok) : this.data.allok ? `<view  class=\"padding flex flex-direction\">\t<button bindtap=\"newpay\" class=\"cu-btn bg-green margin-tb-sm lg\">支付</button>\t</view>`: `3`}`\n            this.setData({html : this.parse(html)});\n          },\n            \n\n  data: {\n    shop:{name:''},\n    buy:{buy:[]},\n    allok:false,\n    sf:\"师范(目前东门自取)\",\n    freepay: false,\n    index: '0',\n    beizu: '',\n    picker: ['预约今天中午', '预约今天晚上', '预约明天中午', '预约明天晚上', ],\n    userinfo:{userlocation:{}},\n  },\n\n  onShow: function (options) {\n    wx.showLoading({\n      mask:true,\n      title: '获取订单信息...',\n    })\n    var self = this\n    db.collection('zzzTEXT').doc('test').get().then(res => {\n      console.log(res.data.freepay)\n      self.setdata({\n        freepay: res.data.freepay\n      })\n    })\n    wx.cloud.callFunction({\n      // 要调用的云函数名称\n      name: 'time',\n      config: {\n        env:'mall-7gi19fir46652cb4'\n      },\n\n      // 传递给云函数的参数\n      data: {},\n      success: res => {\n\n        var nowtime = dayjs(res.result.time).format('HH:mm')\n        console.log(11)\n        if (nowtime < \"11\") {\n          self.setdata({\n            oldindex: '0',\n            index: '0'\n          })\n        }\n        console.log(12)\n        if (nowtime >= \"11\" && nowtime < \"17\") {\n          self.setdata({\n            oldindex: '1',\n            index: '1'\n          })\n        }\n        console.log(13)\n        if (nowtime >= \"17\") {\n          self.setdata({\n            oldindex: '2',\n            index: '2'\n          })\n        }\n        console.log(11)\n        wx.getStorage({\n          key: 'userinfo',\n          success(res) {\n            wx.getStorage({\n              key: 'pay',\n              success(pay) {\n                wx.getStorage({\n                  key: 'shop',\n                  success(shop) {\n                    console.log(shop.data, 233)\n                    console.log(pay.data)\n                    self.setdata({\n                      shop: shop.data,\n                      userinfo: res.data,\n                      buy: pay.data\n                    })\n             \n                      wx.hideLoading()\n                      self.setdata({\n                        allok:true,\n                      })\n                    \n                  }\n                })\n              }\n            })\n          }\n        })\n      },\n      fail: err => {\n        // this.onShow();\n      },\n      complete: () => {\n        \n        // ...\n      }\n    })\n  },\n  /* onShow(e) {\n    var self = this\n    wx.showLoading({\n      mask:true,\n      title: '加载中...',\n    })\n    \n  }, */\n  /* 备注 */\n  beizu(e) {\n    this.setdata({\n      beizu: e.detail.value\n    })\n  },\n  PickerChange(e) {\n    console.log(e);\n    \n    console.log(e.detail.value);\n    var oldindex = this.data.oldindex\n    console.log(\"old:\"+oldindex);\n    if (oldindex <= e.detail.value) {\n      console.log(\"更新\")\n      this.setdata({\n        index: e.detail.value\n      })\n    } else {\n      wx.showToast({\n        icon: \"none\",\n        title: '不在规定时间内',\n      })\n    }\n\n\n  },\n  /* 地址设置 */\n  location(e) {\n    wx.navigateTo({\n      url: '../HotTop/HotTop?content=地址&pay=' + true,\n    })\n  },\n  testpay(e) {\n    wx.showLoading({\n      mask: true,\n      title: '正在调起支付...',\n    })\n    var self = this\n    var shopdayin = self.data.dayin\n    var shop_id = self.data.shop._id //商铺编号\n    var shopid = self.data.shop.shopid //商铺编号\n    var shopname = self.data.shop.name //商铺名称\n    var totalprice = parseFloat(self.data.buy.totalprice).toFixed(2)\n    var aaaa = totalprice.split(\".\")\n    var price = aaaa[0] + aaaa[1]\n    var outTradeNo = shopid + 'A' + price + \"F\" + new Date().getTime() //商户订单号\n    var userinfo = self.data.userinfo\n    var buy = self.data.buy.buy //商品内容\n    var totalnumber = self.data.buy.totalnumber //商品数量\n    //商品价格\n    var day = dayjs().format('YYYY-MM-DD')\n    if (self.data.index > 1) {\n      var day = dayjs().add(1, 'day').format('YYYY-MM-DD')\n    } else {\n   \n    }\n    var yuyue = self.data.picker[self.data.index] //预约情况\n    var beizu = self.data.beizu //备注\n    var xxlocation = userinfo.userlocation.location + '-' + userinfo.userlocation.sushehao + '-' + userinfo.userlocation.name + '-' + userinfo.userlocation.tell\n    if (userinfo.userlocation.tell) {\n      var dingdan = {\n        go: 0, //出单情况  0待出  1已出单\n        day: day, //下单所属日期，预约明天天数加一\n        upday: dayjs().format('YYYY-MM-DD'), //下单日期\n        uptime: dayjs().format('HH:mm:ss'), //下单时间\n        outTradeNo: outTradeNo, //商户订单号\n        school: userinfo.userlocation.school, //地址\n        location: userinfo.userlocation.location, //地址\n        sushehao: userinfo.userlocation.sushehao,\n        name: userinfo.userlocation.name,\n        tell: userinfo.userlocation.tell,\n        shopid: shopid, //商家id\n        shopname: shopname, //商家名字\n        buy: buy, //商品\n        yuyue: yuyue, //预约情况\n        beizu: beizu, //备注\n        totalnumber: totalnumber, //总件数\n        totalprice: parseFloat(parseFloat(totalprice).toFixed(2)), //总价\n      }\n\n      db.collection('dindan').add({\n        data: dingdan,\n        success: function (res) {\n          wx.cloud.callFunction({\n            // 要调用的云函数名称\n            name: 'goodsyuenumber',\n            config: {\n              env:'mall-7gi19fir46652cb4'\n            },\n            // 传递给云函数的event参数\n            data: {\n              shopid: shop_id,\n              buy: buy\n            }\n          }).then(res => {\n            /* util.test(shopdayin,dingdan,shopname) */\n            console.log(res)\n          }).catch(err => {\n            console.log(err)\n          })\n\n          /* wx.cloud.callFunction({\n            // 要调用的云函数名称\n            name: 'goodsdaynumber',\n            // 传递给云函数的event参数\n            data: {\n              shopid: shop_id,\n              buy: buy\n            }\n          }).then(res => {\n            \n          }).catch(err => {\n            console.log(err)\n          }) */\n          wx.hideLoading()\n          wx.reLaunch({\n            url: '../HotTop/HotTop?content=商场&shop_id=' + shop_id,\n          })\n\n        },\n        fail: console.error,\n        complete: console.log\n      })\n\n    } else {\n      wx.showToast({\n        icon: \"none\",\n        title: '请添加送餐地址',\n      })\n    }\n    console.log(dingdan)\n  },\n  pay(e) {\n    wx.showLoading({\n      mask: true,\n      title: '正在调起支付...',\n    })\n    var self = this\n    var num = self.createNonceStr()\n    var shopdayin = self.data.dayin\n    var shop_id = self.data.shop._id //商铺编号\n    var shopid = self.data.shop.shopid //商铺编号\n    var shopname = self.data.shop.name //商铺名称\n    var totalprice = parseFloat(self.data.buy.totalprice).toFixed(2) //商品价格\n    var aaaa = totalprice.split(\".\")\n    var price = aaaa[0] + aaaa[1]\n    var timeStamp = new Date().getTime()\n    var outTradeNo = shopid + 'A' + price + \"F\" + num //商户订单号\n    console.log()\n    var userinfo = self.data.userinfo\n    var buy = self.data.buy.buy //商品内容\n    var totalnumber = self.data.buy.totalnumber //商品数量\n    if (self.data.index > 1) {\n      var day = dayjs().add(1, 'day').format('YYYY-MM-DD')\n    } else {\n      var day = dayjs().format('YYYY-MM-DD')\n    }\n    var yuyue = self.data.picker[self.data.index] //预约情况\n    var beizu = self.data.beizu //备注\n    var xxlocation = userinfo.userlocation.location + '-' + userinfo.userlocation.sushehao + '-' + userinfo.userlocation.name + '-' + userinfo.userlocation.tell\n    console.log(userinfo.userlocation.tell)\n    console.log(xxlocation.length)\n    if (userinfo.userlocation.tell) {\n      var dingdan = {\n        go: 0, //出单情况  0待出  1已出单\n        day: day, //下单所属日期，预约明天天数加一\n        upday: dayjs().format('YYYY-MM-DD'), //下单日期\n        uptime: dayjs().format('HH:mm:ss'), //下单时间\n        outTradeNo: outTradeNo, //商户订单号\n        school: userinfo.userlocation.school, //地址\n        location: userinfo.userlocation.location, //地址\n        sushehao: userinfo.userlocation.sushehao,\n        name: userinfo.userlocation.name,\n        tell: userinfo.userlocation.tell,\n        shopid: shopid, //商家id\n        shopname: shopname, //商家名字\n        buy: buy, //商品\n        yuyue: yuyue, //预约情况\n        beizu: beizu, //备注\n        totalnumber: totalnumber, //总件数\n        totalprice: parseFloat(parseFloat(totalprice).toFixed(2)), //总价\n      }\n\n      wx.cloud.callFunction({\n        name: 'pay',\n        config: {\n          env:'mall-7gi19fir46652cb4'\n        },\n        data: {\n          beizu: beizu,\n          yuyue: yuyue,\n          buy: buy,\n          shangpuname: shopname,\n          outTradeNo: outTradeNo,\n          price: price,\n        },\n        success: res => {\n          wx.hideLoading()\n          console.log('获取支付参数成功：', res)\n          const payment = res.result.payment\n          console.log('获取支付参数成功：', payment)\n          \n          wx.requestPayment(Object.assign(payment, {\n\n            success(res) {\n              console.log('支付成功：', res)\n              db.collection('dindan').add({\n                data: dingdan,\n                success: function (res) {\n                  wx.cloud.callFunction({\n                    // 要调用的云函数名称\n                    name: 'goodsyuenumber',\n                    config: {\n                      env:'mall-7gi19fir46652cb4'\n                    },\n                    // 传递给云函数的event参数\n                    data: {\n                      shopid: shop_id,\n                      buy: buy\n                    }\n                  }).then(res => {\n                    wx.showToast({\n                      title: '成功',\n                      icon: 'success',\n                      duration: 2000\n                    })\n                    setTimeout(() => {\n                      wx.reLaunch({\n                        url: '../HotTop/HotTop?content=商场&shop_id=' + shop_id,\n                      })\n                    }, 1500)\n                    wx.hideLoading()\n                  }).catch(err => {\n                    console.log(err)\n                  })\n                  /* util.test(shopdayin,dingdan,shopname) */\n                },\n                fail: console.error,\n                complete: console.log\n              })\n            },\n            fail(err) {\n              console.error('支付失败：', err)\n            }\n          }))\n        },\n        fail: res => {\n          console.log('获取支付参数失败：' + res)\n        },\n      })\n\n    } else {\n      wx.hideLoading()\n      wx.showToast({\n        icon: \"none\",\n        title: '请添加送餐地址',\n      })\n    }\n\n  },\n  newpay(e) {\n    wx.showLoading({\n      mask: true,\n      title: '正在调起支付...',\n    })\n    var self = this\n    var num = self.createNonceStr()\n    var shopdayin = self.data.dayin\n    var shop_id = self.data.shop._id //商铺编号\n    var shopid = self.data.shop.shopid //商铺编号\n    var shopname = self.data.shop.name //商铺名称\n    var totalprice = parseFloat(self.data.buy.totalprice).toFixed(2) //商品价格\n    var aaaa = totalprice.split(\".\")\n    var price = aaaa[0] + aaaa[1]\n    var timeStamp = new Date().getTime()\n    var outTradeNo = \"A\"+timeStamp+ \"F\" + num //商户订单号\n    console.log(outTradeNo)\n    var userinfo = self.data.userinfo\n    var buy = self.data.buy.buy //商品内容\n    var totalnumber = self.data.buy.totalnumber //商品数量\n    var day = dayjs().format('YYYY-MM-DD')\n    if (self.data.index > 1) {\n      var day = dayjs().add(1, 'day').format('YYYY-MM-DD')\n    } else {\n   \n    }\n    var yuyue = self.data.picker[self.data.index] //预约情况\n    var beizu = self.data.beizu //备注\n    var xxlocation = userinfo.userlocation.location + '-' + userinfo.userlocation.sushehao + '-' + userinfo.userlocation.name + '-' + userinfo.userlocation.tell\n    console.log(userinfo.userlocation.tell)\n    console.log(xxlocation.length)\n    if (userinfo.userlocation.tell) {\n      var dingdan = {\n        _id: outTradeNo,\n        go: 0, //出单情况  0待出  1已出单\n        day: day, //下单所属日期，预约明天天数加一\n        upday: dayjs().format('YYYY-MM-DD'), //下单日期\n        uptime: dayjs().format('HH:mm:ss'), //下单时间\n        outTradeNo: outTradeNo, //商户订单号\n        location: userinfo.userlocation.location, //地址\n        school: userinfo.userlocation.school, \n        sushehao: userinfo.userlocation.sushehao,\n        name: userinfo.userlocation.name,\n        tell: userinfo.userlocation.tell,\n        shopid: shopid, //商家id\n        shopname: shopname, //商家名字\n        buy: buy, //商品\n        yuyue: yuyue, //预约情况\n        beizu: beizu, //备注\n        totalnumber: totalnumber, //总件数\n        totalprice: parseFloat(parseFloat(totalprice).toFixed(2)), //总价\n      }\n      db.collection('zdindan').add({\n        data: dingdan,\n        success: function (res) {\n          wx.cloud.callFunction({\n            name: 'newpay',\n            config: {\n              env:'mall-7gi19fir46652cb4'\n            },\n            data: {\n              buy: buy,\n              dingdan: dingdan,\n              shangpuname: shopname,\n              outTradeNo: outTradeNo,\n              price: price,\n            },\n            success: res => {\n              wx.hideLoading()\n              console.log('获取支付参数成功：', res)\n              const payment = res.result.payment\n              console.log('获取支付参数成功：', payment)\n              wx.requestPayment(Object.assign(payment,{\n                success(res) {\n                  console.log('支付成功：', res)\n                  db.collection('dindan').where({\n                    _id: outTradeNo,\n                  }).count().then(res => {\n                    console.log(res.total)\n                    if (res.total == 0) {\n                      db.collection('dindan').add({\n                        data: dingdan,\n                        success: function (res) {\n                          wx.cloud.callFunction({\n                            // 要调用的云函数名称\n                            name: 'goodsyuenumber',\n                            config: {\n                              env:'mall-7gi19fir46652cb4'\n                            },\n                            // 传递给云函数的event参数\n                            data: {\n                              shopid: shop_id,\n                              buy: buy\n                            }\n                          }).then(res => {\n                            wx.showToast({\n                              title: '成功',\n                              icon: 'success',\n                              duration: 2000\n                            })\n                            setTimeout(() => {\n                              wx.reLaunch({\n                                url: '../HotTop/HotTop?content=商场&shop_id=' + shop_id,\n                              })\n                            }, 1500)\n                            wx.hideLoading()\n                          }).catch(err => {\n                            console.log(err)\n                          })\n                          /* util.test(shopdayin,dingdan,shopname) */\n                        },\n                        fail: console.error,\n                        complete: console.log\n                      })\n                    }\n                  })\n\n                },\n                fail(err) {\n                  db.collection('zdindan').doc(outTradeNo).remove()\n                    .then(console.log)\n                    .catch(console.error)\n                  wx.hideLoading()\n                  console.error('支付失败：', err)\n                }\n              }))\n            },\n            fail: res => {\n              db.collection('zdindan').doc(outTradeNo).remove()\n                .then(console.log)\n                .catch(console.error)\n              wx.hideLoading()\n              console.log('获取支付参数失败：' + res)\n            },\n          })\n        },\n        fail: res => {\n          wx.hideLoading()\n          console.log('获取支付参数失败：' + res)\n        },\n        complete: console.log\n      })\n    } else {\n      wx.hideLoading()\n      wx.showToast({\n        icon: \"none\",\n        title: '请添加送餐地址',\n      })\n    }\n\n  },\n\n  createNonceStr: function () {\n    var str = \"\",\n      range = 7, //min\n      arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];\n\n    // 随机产生\n    /* if (true) {\n      range = Math.round(Math.random() * (36 - 20)) + 20;\n    } */\n    for (var i = 0; i < range; i++) {\n      var pos = Math.round(Math.random() * (arr.length - 1));\n      str += arr[pos];\n    }\n    return str;\n  },\n\n})\n      \n      \n        }\n            window.exports = runCode;\n        \n            "],"names":[],"sourceRoot":""}